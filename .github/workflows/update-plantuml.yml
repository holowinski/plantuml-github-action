name: Update PlantUML
on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:
    inputs:
      plantuml_version:
        description: "Plant UML version"
        type: string

jobs:
  bump_plantuml:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: plantuml
        # using plantuml-server because plantuml for some reason returns empty list of releases
        name: PlantUML latest release
        run: |
          echo "name=tag::$(test $(echo '${{ inputs.plantuml_version }}')) && echo '${{ inputs.plantuml_version }}' || $(curl -s https://api.github.com/repos/plantuml/plantuml-server/releases/latest | grep tag_name | sed 's/.*"tag_name": "v\(.*\)",/\1/')" >> $GITHUB_OUTPUT

      - name: "Get latest tag"
        id: current
        run: |
          echo "name=tag::$(git ls-remote --tags --refs --sort="v:refname" origin | tail -n1 | sed 's/.*\///')" >> $GITHUB_OUTPUT

      - name: Bump docker version
        if: ${{ steps.plantuml.outputs.tag != steps.current.outputs.tag }}
        run: |
          sed -i "s#holowinski/plantuml:.*#holowinski/plantuml:${{ steps.plantuml.outputs.tag }}\"#" action.yml

      - name: Commit PlantUML bump
        if: ${{ steps.plantuml.outputs.tag != steps.current.outputs.tag }}
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          ref: ${{ github.head_ref }}
          commit_message: "Bump PlantUML to ${{ steps.plantuml.outputs.tag }}"

      - name: Set up QEMU
        if: ${{ steps.plantuml.outputs.tag != steps.current.outputs.tag }}
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: ${{ steps.plantuml.outputs.tag != steps.current.outputs.tag }}
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        if: ${{ steps.plantuml.outputs.tag != steps.current.outputs.tag }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        if: ${{ steps.plantuml.outputs.tag != steps.current.outputs.tag }}
        id: docker_build
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: holowinski/plantuml:latest, holowinski/plantuml:${{ steps.plantuml.outputs.tag }}
          build-args: |
            PLANTUML_VERSION=${{ steps.plantuml.outputs.tag }}

      - name: Create tag
        if: ${{ steps.plantuml.outputs.tag != steps.current.outputs.tag }}
        run: |
          git tag -a ${{ steps.plantuml.outputs.tag }} -m 'PlantUML ${{ steps.plantuml.outputs.tag }}'
          git push origin tag ${{ steps.plantuml.outputs.tag }}
